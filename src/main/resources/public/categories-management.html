<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Nutricipe</title>
	<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
		integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
	<script src="assets/js/jquery/jquery-3.5.1.js"></script>
	<!--<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
		integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
		crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
		integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
		crossorigin="anonymous"></script>
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
		integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
	<link rel="stylesheet" href="assets/styles/style.css">
	<!-- <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/font-awesome.min.css" rel="stylesheet">
    <link href="assets/css/main.css" rel="stylesheet">-->

</head>

<body>
	<div class="container-lg container-fluid ">
		<div class="fixed-header">
			<div class="row bg-danger shadow py-4">
				<div class="col text-white">
					<h1 class="text-center mb-0">Nutricipe</h1>
					<div class="text-center">
						<span>Nutricious Recipes Galore</span>
					</div>
				</div>
			</div>
			<div class="row bg-danger justify-content-center">
				<span id="current-user-username"
				class="bg-white text-danger rounded text-white px-2 py-1 m-2"></span>
				<a id="home-link" class="nav-item nav-link active text-white" href="/home">Home</a>
                <a id="profile-link" class="nav-item nav-link text-white" href="profile.html">Profile</a>
                <a id="users-link" class="nav-item nav-link text-white" href="users.html">Users</a>
                <!--<a id="products-link" class="nav-item nav-link text-white" href="products.html">Products</a>
                <a id="nutrients-link" class="nav-item nav-link text-white" href="nutrients.html">Nutrients</a>
                <a id="recipes-link" class="nav-item nav-link text-white" href="recipes.html">Recipes</a>-->
                <a id="diets-link" class="nav-item nav-link text-white" href="diet-management.html">Diets</a>
                <a id="categories-link" class="nav-item nav-link text-white" href="categories-management.html">Categories</a>
                <a id="logout-link" class="nav-item nav-link text-white" href="/logout">Log Out</a>
			</div>
				<!--START OF SEARCH SECTION-->
		<div class="row shadow p-2 bg-light">
			<div class="d-flex align-items-center col-lg-2 col-12">
				<button id="change-view-btn" class="btn btn-danger text-center btn-block lg-btn my-2 my-lg-0"
					style="display: none;">Change View</button>
			</div>
			<div class="d-flex align-items-center col-lg-6 col-12 justify-content-center">
				<div class="d-flex align-items-center">
					<span class="text-danger h4">Search: </span>
				</div>
				<form class="d-flex align-items-center">
					<div class="custom-control">
						<input type="text" class="form-control" id="search-text"
							placeholder="Salad">
					</div>
					<!--<div class="custom-control">
						<select id="select-search-type" class="form-control">
							<option value="recipe" selected >Recipe</option>
							<option value="product">Product</option>
						</select>
					</div>-->
				</form>
			</div>
			
			<div class="d-flex align-items-center col-lg-2 col-12">
				<button id="search-btn"
					class="btn btn-danger text-center btn-block lg-btn my-2 my-lg-0">Search</button>
					<button id="clear-btn"
					class="btn btn-danger text-center btn-block lg-btn ml-2 my-2 my-lg-0">Clear</button>
			</div>
		</div>
		<!--END OF SEARCH SECTION-->
		<div id="mbar" class="text-center bg-white text-danger font-weight-bold"></div>
		</div>
	
		<div class="container">


			<div class="row mt-4">

				<div class="col-sm-4 ">


					<div class="panel-heading">
						<h3 class="text-center text-danger">Manage Category:</h3>
					</div>

					<div id="registration-row" class="row d-flex justify-content-center my-3">
						<div class="col shadow p-4">

							<form id="register-form" action="register" method="POST">
								<div class="form-group">
									<label for="category-name-form" class="text-danger">Name:</label>
									<input type="text" class="form-control" id="category-name-form" name="categoryName" required
										placeholder="">
								</div>
								<!--<div class="form-group">
									<label for="category-type-form" class="text-danger">Type:</label>
									<input type="text" class="form-control" id="category-type-form" name="categoryType" required
										placeholder="">
								</div>-->
								<div class="form-group">
									<label for="category-type-form-select" class="text-danger">Type:</label>
									<select type="text" class="form-control" id="category-type-form-select" required>
										<option value='0' selected>Please select a type</option>
										<option value='Adverse Effects'>Adverse Effects</option>
										<option value='Dish Types'>Dish Types</option>
										<option value='Food Types'>Food Types</option>
										<option value='Benefit'>Benefit</option>
									</select>
								</div>
								<div class="text-center">
									<input type="hidden" name="action" value="register">
									<input type="hidden" id="user-id" name="User-current">
									<input type="hidden" id="current-user"name="currentUser">
                                    <input type="hidden" id="category-id" name="categoryId">
									<button id="submit-category" type="button" class="btn btn-success">Add</button>
									<button id="update-category" type="button" class="btn btn-primary">Update</button>
									<button id="clear-category" type="button" class="btn btn-danger">Clear</button>
									<!--  <button id="back" class="btn btn-danger" type="button">Back</button>-->
								</div>
							</form>
						</div>

					</div>


				</div>
				<div class="col-sm-8">
					<div class="panel-heading">
						<h3 class="text-center text-danger">Categories:</h3>
					</div>
					<div id="category-container" class="d-flex flex-wrap justify-content-center">



					</div>
				</div>
			</div>

		</div>
	</div>
	<div id="empty-template">
        <h5 class="text-center text-danger"></h5>
    </div>
	<div id="category-template" style="display: none;" class="shadow m-2">
		<div class="card-body">
			<p id="category-name" class="card-text border-bottom">Name</p>
			<p id="category-type" class="card-text border-bottom">Type</p>
			<div class="text-center">
				<button class="btn btn-danger btn-act mb-3 mx-2" type="button">Remove</button>
				<button class="btn btn-primary mb-3 mx-2" type="button">Edit</button>
			</div>
		</div>
	</div>

</body>
<script>
	$(document).ready(function () {
		getCurrentUser();
		clearFields();
		fetchAllCategories();
		//getDiets();
		$('#update-category').attr("disabled", true);
		$('#update-category').hide();
		$('#submit-category').show();
		$('#clear-category').hide();
		$('#clear-category').on('click', function(){
			$('#clear-category').hide();
			$('#update-category').attr("disabled", true);
			$('#submit-category').removeAttr("disabled");
			$('#update-category').hide();
			$('#submit-category').show();
			$('#category-name-form').val("");
			//$('#category-type-form').val("");
			$('#category-type-form-select').val("0");

		})
        /*function getDiets(){
            $.ajax({
				url: "/diet/all",
				method: "GET",
				success: function (data) {
					if(data){
                        for(i=0;i<data.length;i++){
							(function(i){populateDietDropdown(data[i])})(i);
                          }
                    }
				},
				fail: function () {

					alert("Something went wrong!")
				}
			})
		}

        function populateDietDropdown(diet){
            var dropDown = $('#select-diet');
            dropDown.append('<option value=' + diet.id + '>' + diet.name + '</option>');
        }*/
		function fetchAllCategories() {

            //response.responseJSON.length>0
			$.ajax({
				url: "/category",
				method: "GET",
				complete: function (response) {
					/*if (response !== null) {
						for (i = 0; i < response.length; i++) {
							(function (i) { populateUserContainer(response[i], i) })(i);
						}
					}
					else {
						alert("Please login and try again!");
						windows.location.href = "/login?logout";
					}*/
                    if (response.status == 401){
                        toggleNotification("You are unauthorized to perform this operation. Please log in again!");
                    }
                    if (response.status == 200){
                        if (response.responseJSON.length>0){
                        response.responseJSON.forEach(function(category) {
                        populateCategoryContainer(category);
						//populateCategoryDropdown(category);
                        });
                        }

                    }
                    if (response.status == 404){
                        toggleNotification("The requested resource couldn't be found!");
                    }
				}
			})


		}

		function populateCategoryContainer(category) {
			var template = $('#category-template').clone();
			template.removeAttr("style");
			template.addClass("d-flex");
			template.attr('id', 'category-card-' + category.id);
			template.find('#category-name').text(category.name);
			template.find('#category-type').text(category.type);
			$('#update-category').removeAttr("disabled")
			//alert(post.text)
			var button = template.find('.btn-act');
			button.html("Remove");
			button.on('click', function () {

				deleteCategoryById(category.id, template);


			})
			template.find('.btn-primary').on('click', function () {
				$('#update-category').removeAttr("disabled")
				$('#update-category').show();
				$('#submit-category').attr("disabled", true)
				$('#submit-category').hide();
				$('#clear-category').show();
				updatePressed = true

				//$('#create-update-quote').text("Edit Quote:");
				$('#category-id').val(category.id);
				$('#category-name-form').val(category.name);
				$('#category-type-form').val(category.type);
				//$('#category-type-form').val(category.type);
				$('#category-type-form-select').val(category.type);
				//$('#select-diet').val(user.diet.id);

				//$('#submit-custom-quote').html("Update Quote")
				//$('#submit-custom-quote').attr("id","update-custom-quote")
				//$('#custom-quote-id').val(quote.id);

			})


			$('#category-container').append(template);
			template.show();
		}

		function addCategory(name, type) {
			if (name != '' && type != '') {
				$.ajax({
					url: "/category",
					method: "POST",
					data: {
						name: name,
						type: type,
					},
					complete: function (response) {
						/*if (response.includes("Error")) {
							alert(response)
						}
						else {


							alert("User has been created successfully")
							fetchAllUsers();
							clearFields();
							$('#register-username').text('');


						}*/
                        if (response.status == 409){
                            toggleNotification("A category with the specified name already exists in the specified category, please choose another one!");
                        }
                        if (response.status == 201){
                            toggleNotification("Category has been created successfully!");
                            fetchAllCategories();
                            clearFields();
                        }
                        if (response.status == 400){
                            toggleNotification("You have supplied invalid input parameters. Please fill the required fields again!");
                        }
                        if (response.status == 500){
                            toggleNotification("Category creation failed!");
                        }
                        if (response.status == 401){
                            toggleNotification("You are unauthorized to perform this operation. Please log in and try again!");
                        }
					}
					
				})
			}
			else {
				toggleNotification("Please fill in all fields");
			}

		}

		$('#update-category').on('click', function () {
			updateCategory();
			
		})
		$('#submit-category').on('click', function () {
			$('#category-name-form').val();
			$('#category-type-form').val();
			var name = $('#category-name-form').val();
			//var type = $('#category-type-form').val();
			var type = $('#category-type-form-select').val();
			//var password = $('#register-pass').val();
			//var repeatPassword = $('#confirm-register-pass').val();
			//var dietId = $('#select-diet').val();


			if (name === "" || type === "") {
				toggleNotification("Please fill in the requested fields");
				return

			}
			if (type === "0") {
				toggleNotification("Please select a category");
				return

			}
			addCategory(name, type);





			//if (username!='' && email!='' && password!='' && repeatPassword!=''){
			//addUser(email,username,password,repeatPassword);
			//}
			//else{
			//	alert("Please fill all fields")
			//}
		})
		function clearFields() {
			$('#category-name-form').val('');
			$('#category-name-form').text('');
			$('#category-type-form-select').val("0");
			//$('#category-type-form').val('');
			//$('#category-type-form').text('');
			//$("#register-pass").val('');
			//$("#register-pass").text('');
			//$('#confirm-register-pass').val('');
			//$('#confirm-register-pass').text('');
			$('#category-container').empty();
			$('#update-category').attr("disabled", true);
			$('#update-category').hide();
			$('#submit-category').removeAttr("disabled");
			$('#submit-category').show();
			$('#clear-category').hide();
			$('#category-id').val();
			$('#clear-category').hide();
			//$('#update-category').attr("disabled", true);
			//$('#submit-category').removeAttr("disabled");
			//$('#update-category').hide();
			//$('#submit-category').show();
			//$('#category-name-form').val("");
			//$('#category-type-form').val("");
			$('#category-type-form-select').val("0");
			
			//$('#select-diet').val('');



		}
		function deleteCategoryById(id, template) {
			$.ajax({
				url: "/category/"+ id,
				method: "DELETE",
				complete: function (data) {
					if (data.status == 200) {
						toggleNotification("Delete Successful")
						template.remove();
						clearFields();
					}
					if (data.status == 401) {
						toggleNotification("Delete Failed!!!")
					}
					if (data.status == 404) {
						toggleNotification("Delete Failed!!! No such user exists")
					}
                    if (data.status == 400) {
						toggleNotification("Input parameters are invalid! Delete operation failed!")
					}
				}
			})
		}





		function getCurrentUser() {
			$.ajax({
				url: "/user/current",
				method: "GET",
				success: function (data) {
					if (data != null) {
						visualiseCurrentUser(data);
						//showLoggedUsername(user.username);
					}
				}
			})

		}

		function visualiseCurrentUser(user) {
			$('#current-user-username').text(user.username)
			$('#current-user').val(user.id)
		}


		function updateCategory() {
			var categoryId = $('#category-id').val();
			var name = $('#category-name-form').val();
			//var type = $('#category-type-form').val();
			var type = $('#category-type-form-select').val();
			//var password = $('#register-pass').val();
			//var repeatPassword = $('#confirm-register-pass').val();
			//var dietId = $('#select-diet').val();
			if (name === "" || type === "") {
				toggleNotification("Please fill in the requested fields");
				return

			}
			if (type === "0") {
				toggleNotification("Please select a category");
				return

			}
			//if (!email.includes('@') || !email.includes('.')) {
			//	alert("Email is not valid");
			//	return
			//}
			//if (password != repeatPassword) {
			//	alert("Password must be confirmed");
			//	return
			//}

			$.ajax({
				url: "/category/"+categoryId,
				method: "PUT",
				data: {
					name: name,
					type: type,
				},
				complete: function (response) {
                        if (response.status == 409){
                            toggleNotification("A category with the specified name already exists in the specified category, please choose another one!");
                        }
                        if (response.status == 200){
                            toggleNotification("Category has been updated successfully!");
                            fetchAllCategories();
                            clearFields();
                            updatePressed = false;
                        }
                        if (response.status == 400){
                            toggleNotification("You have supplied invalid input parameters. Please fill the required fields again!");
                        }
                        if (response.status == 500){
                            toggleNotification("Category update failed!");
                        }
                        if (response.status == 401){
                            toggleNotification("You are unauthorized to perform this operation. Please log in and try again!");
                        }
				}
				
			})
		}
		function showLoggedUsername(username) {
			$('#logged-user-name').text(username);

		}
		//function populateCategoryDropdown(category){
            //var dropDown = $('#category-type-form-select');
            //dropDown.append('<option value=' + category.type + '>' + category.type + '</option>');
        //}

		$('#search-btn').on('click',function(){
            
            var searchTerm = $('#search-text').val().trim();
            //var searchType = $('#select-search-type').val().trim();
            if(searchTerm.length>0){
                //if(searchType.length>0){
                Search(searchTerm);
                $('#clear-btn').show();
                //}
                //else{
                    //alert('Incorrect Search Type!');
                //}
            }
            else{
                toggleNotification('Please fill out the search field!');
            }
        })
		function Search(searchTerm){
           
                 
                    $.ajax({
            		url: "/category/search",
            		method: "POST",
                    //contentType: "application/json",
                    //traditional: true,
            		data : {
            			searchTerm: searchTerm,
            		},
            		complete : function(response){
                        if(response.status==200){
                            console.log(response);
                            clearCategoryContainer();
                            //clearProductContainer();
                            //HideProductsSegment();
                            console.log(response);
                            if(response.responseJSON.length>0){
                        response.responseJSON.forEach(function(category) {
                        populateCategoryContainer(category);

                        });
                        }
                        else{
                        var template = $('#empty-template').clone();
                        template.find('h5').text("No Categories have been found");
                        $('#category-container').append(template);
                        template.show();
                        }
                       
                    
                            
                        }
                        if(response.status==401){
                            toggleNotification("You are not authorized to perform this operation. Please log in and try again!");

                        }
                        if(response.status==404){
                            clearCategoryContainer();
                            //HideProductsSegment();
                            //clearRecipeContainer();
                            //ShowRecipesSegment();
                            //alert("Resource couldnt be found!");
                            var template = $('#empty-template').clone();
                            template.find('h5').text("No Categories have been found");
                            $('#category-container').append(template);
                            template.show();

                        }
            		},
            		fail : function(){
            			
            			toggleNotification("Something went terribly wrong!!!");
            		}
            	})
                    
                


        }
		function clearCategoryContainer(){
			$('#category-container').empty();
		}
		$('#clear-btn').hide();
        $('#clear-btn').on('click',function(){
            $('#clear-btn').hide();
            $('#search-text').text("");
			$('#search-text').val("");
            clearCategoryContainer();
            fetchAllCategories();
        })
		function toggleNotification(message){
		var bar = document.createElement("div");
  		bar.innerHTML = message;
  		bar.classList.add("mbar");
		document.getElementById("mbar").appendChild(bar);
		setTimeout(function(){
			document.getElementById("mbar").removeChild(bar);
  },2000);
	}
	})




</script>

</html>