<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Nutricipe</title>
	<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
		integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
	<script src="assets/js/jquery/jquery-3.5.1.js"></script>
	<!--<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
		integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
		crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
		integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
		crossorigin="anonymous"></script>
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
		integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
	<link rel="stylesheet" href="assets/styles/style.css">
	<!-- <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/font-awesome.min.css" rel="stylesheet">
    <link href="assets/css/main.css" rel="stylesheet">-->

</head>

<body>
	<div class="container-lg container-fluid ">
		<div class="fixed-header">
			
			<div class="row bg-danger shadow py-4">
				<div class="col text-white">
					<h1 class="text-center mb-0">Nutricipe</h1>
					<div class="text-center">
						<span>Nutricious Recipes Galore</span>
					</div>
				</div>
			</div>
			<div class="row bg-danger justify-content-center">
				<span id="current-user-username"
				class="bg-white text-danger rounded text-white px-2 py-1 m-2"></span>
				<a id="home-link" class="nav-item nav-link active text-white" href="/home">Home</a>
                <a id="profile-link" class="nav-item nav-link text-white" href="profile.html">Profile</a>
                <a id="users-link" class="nav-item nav-link text-white" href="users.html">Users</a>
                <!--<a id="products-link" class="nav-item nav-link text-white" href="products.html">Products</a>
                <a id="nutrients-link" class="nav-item nav-link text-white" href="nutrients.html">Nutrients</a>
                <a id="recipes-link" class="nav-item nav-link text-white" href="recipes.html">Recipes</a>-->
                <a id="diets-link" class="nav-item nav-link text-white" href="diet-management.html">Diets</a>
                <a id="categories-link" class="nav-item nav-link text-white" href="categories-management.html">Categories</a>
                <a id="logout-link" class="nav-item nav-link text-white" href="/logout">Log Out</a>
			</div>
			<!--START OF SEARCH SECTION-->
		<div class="row shadow p-2 bg-light">
			<div class="d-flex align-items-center col-lg-2 col-12">
				<button id="change-view-btn" class="btn btn-danger text-center btn-block lg-btn my-2 my-lg-0"
					style="display: none;">Change View</button>
			</div>
			<div class="d-flex align-items-center col-lg-6 col-12 justify-content-center">
				<div class="d-flex align-items-center">
					<span class="text-danger h4">Search: </span>
				</div>
				<form class="d-flex align-items-center">
					<div class="custom-control">
						<input type="text" class="form-control" id="search-text"
							placeholder="John">
					</div>
					<!--<div class="custom-control">
						<select id="select-search-type" class="form-control">
							<option value="recipe" selected >Recipe</option>
							<option value="product">Product</option>
						</select>
					</div>-->
				</form>
			</div>
			
			<div class="d-flex align-items-center col-lg-2 col-12">
				<button id="search-btn"
					class="btn btn-danger text-center btn-block lg-btn my-2 my-lg-0">Search</button>
					<button id="clear-btn"
					class="btn btn-danger text-center btn-block lg-btn ml-2 my-2 my-lg-0">Clear</button>
			</div>
		</div>
		<!--END OF SEARCH SECTION-->
		<div id="mbar" class="text-center bg-white text-danger font-weight-bold"></div>
		</div>
		<div class="container">
			
			<div class="row mt-4">
				<div class="col-sm-4 ">


					<div class="panel-heading">
						<h3 class="text-center text-danger">Manage Account:</h3>
					</div>

					<div id="registration-row" class="row d-flex justify-content-center my-3">
						<div class="col shadow p-4">

							<form id="register-form" action="register" method="POST">
								<div class="form-group">
									<label for="register-user" class="text-danger">Username:</label>
									<input type="text" class="form-control" id="register-user" name="username" required
										placeholder="">
								</div>
								<div class="form-group">
									<label for="register-email" class="text-danger">Email:</label>
									<input type="email" class="form-control" id="register-email" name="email" required
										placeholder="">
								</div>

								<div class="form-group">
									<label for="register-pass" class="text-danger">Password:</label>
									<input type="password" class="form-control" id="register-pass" name="password"
										required placeholder="">
								</div>
								<div class="form-group">
									<label for="confirm-register-pass" class="text-danger">Repeat Password:</label>
									<input type="password" class="form-control" id="confirm-register-pass"
										name="repeatPassword" required placeholder="">

								</div>
								<div class="form-group">
									<label id="select-diet-label" for="select-diet">Diet:</label>
									<select id="select-diet" class="form-control">
										
									</select>
								</div>
								<div class="text-center">
									<input type="hidden" name="action" value="register">
									<input type="hidden" id="user-id" name="User-current">
									<button id="submit-user" type="button" class="btn btn-success">Add</button>
									<button id="update-user" type="button" class="btn btn-primary">Update</button>
									<!--  <button id="back" class="btn btn-danger" type="button">Back</button>-->
								</div>
							</form>
						</div>

					</div>


				</div>
				<div class="col-sm-8">
					<div class="panel-heading">
						<h3 class="text-center text-danger">Users:</h3>
					</div>
					<!--<div class="notify"><span id="notifyType" class=""></span></div>-->
					<div id="user-container" class="d-flex flex-wrap justify-content-center">
						



					</div>
				</div>
			</div>

		</div>
	</div>
	<div id="empty-template">
        <h5 class="text-center text-danger"></h5>
    </div>

	<div id="user-template" style="display: none;" class="shadow m-2">
		<div class="card-body">
			<p id="username-text" class="card-text border-bottom">Username</p>
			<p id="email-text" class="card-text border-bottom">Email</p>
			<div class="text-center">
				<button class="btn btn-danger btn-act mb-3 mx-2" type="button">Remove</button>
				<button class="btn btn-primary mb-3 mx-2" type="button">Edit</button>
			</div>
		</div>
	</div>

</body>
<script>
	$(document).ready(function () {
		getCurrentUser();
		clearFields();
		fetchAllUsers();
		getDiets();
		$('#update-user').attr("disabled", true);
		$('#update-user').hide();
		$('#submit-user').show();
	
        function getDiets(){
            $.ajax({
				url: "/diet/all",
				method: "GET",
				success: function (data) {
					if(data){
                        for(i=0;i<data.length;i++){
							(function(i){populateDietDropdown(data[i])})(i);
                          }
                    }
				},
				fail: function () {

					toggleNotification("Something went wrong!")
				}
			})
		}

        function populateDietDropdown(diet){
            var dropDown = $('#select-diet');
            dropDown.append('<option value=' + diet.id + '>' + diet.name + '</option>');
        }
		function fetchAllUsers() {
			$.ajax({
				url: "/user/all",
				method: "GET",
				success: function (response) {
					if (response !== null) {
						for (i = 0; i < response.length; i++) {
							(function (i) { populateUserContainer(response[i], i) })(i);
						}
					}
					else {
						toggleNotification("Please login and try again!");
						windows.location.href = "/login?logout";
					}
				},
				fail: function () {
					toggleNotification("Something went wrong!")
				}
			})


		}

		function populateUserContainer(user, i) {
			var template = $('#user-template').clone();
			template.removeAttr("style");
			template.addClass("d-flex");
			template.attr('id', 'user-card-' + user.id);
			template.find('#username-text').text(user.username);
			template.find('#email-text').text(user.email);
			$('#update-post').removeAttr("disabled")
			//alert(post.text)
			var button = template.find('.btn-act');
			button.html("Remove");
			button.on('click', function () {

				deleteUserById(user.id, template);


			})
			template.find('.btn-primary').on('click', function () {
				$('#update-user').removeAttr("disabled")
				$('#update-user').show();
				$('#submit-user').attr("disabled", true)
				$('#submit-user').hide();
				updatePressed = true

				//$('#create-update-quote').text("Edit Quote:");
				$('#user-id').val(user.id);
				$('#register-user').val(user.username);
				$('#register-email').val(user.email);
				$('#select-diet').val(user.diet.id);

				//$('#submit-custom-quote').html("Update Quote")
				//$('#submit-custom-quote').attr("id","update-custom-quote")
				//$('#custom-quote-id').val(quote.id);

			})


			$('#user-container').append(template);
			template.show();
		}

		function addUser(email, username, password, repeatPassword, dietId) {
			if (username != '' && email != '' && password != '' && repeatPassword != '') {
				$.ajax({
					url: "/register",
					method: "POST",
					data: {
						email: email,
						username: username,
						password: password,
						repeatPassword: repeatPassword,
						diet: dietId,
					},
					success: function (response) {
						if (response.includes("Error")) {
							toggleNotification(response)
						}
						else {


							toggleNotification("User has been created successfully")
							fetchAllUsers();
							clearFields();
							$('#register-username').text('');


						}
					},
					fail: function () {

						toggleNotification("Something went terribly wrong!!!")
					}
				})
			}
			else {
				toggleNotification("Please fill all fields");
			}

		}

		$('#update-user').on('click', function () {
			updateUser();
		})
		$('#submit-user').on('click', function () {
			$('#register-user').val();
			$('#register-email').val();
			var username = $('#register-user').val();
			var email = $('#register-email').val();
			var password = $('#register-pass').val();
			var repeatPassword = $('#confirm-register-pass').val();
			var dietId = $('#select-diet').val();


			if (username === "" || email === "" || password === "" || repeatPassword === "") {
				toggleNotification("Please fill in the requested fields");
				return

			}
			if (!email.includes('@') || !email.includes('.')) {
				toggleNotification("Email is not valid");
				return
			}
			if (password != repeatPassword) {
				toggleNotification("Password must be confirmed");
				return
			}

			addUser(email, username, password, repeatPassword,dietId);





			//if (username!='' && email!='' && password!='' && repeatPassword!=''){
			//addUser(email,username,password,repeatPassword);
			//}
			//else{
			//	alert("Please fill all fields")
			//}
		})
		function clearFields() {
			$('#register-username').val('');
			$('#register-username').text('');
			$('#register-email').val('');
			$('#register-username').text('');
			$("#register-pass").val('');
			$("#register-pass").text('');
			$('#confirm-register-pass').val('');
			$('#confirm-register-pass').text('');
			$('#user-container').empty();
			$('#update-user').attr("disabled", true);
			$('#update-user').hide();
			$('#submit-user').removeAttr("disabled");
			$('#submit-user').show();
			$('#select-diet').val('');



		}
		function deleteUserById(id, template) {
			$.ajax({
				url: "/user/deletebyId",
				method: "DELETE",
				data: { id: id },
				complete: function (data) {
					if (data.status == 200) {
						toggleNotification("Delete Successful")
						template.remove();
					}
					if (data.status == 401) {
						toggleNotification("Delete Failed!!!")
					}
					if (data.status == 404) {
						toggleNotification("Delete Failed!!! No such user exists")
					}
				}
			})
		}





		function getCurrentUser() {
			$.ajax({
				url: "/user/current",
				method: "GET",
				success: function (data) {
					if (data != null) {
						visualiseCurrentUser(data);
						//showLoggedUsername(user.username);
					}
				}
			})

		}

		function visualiseCurrentUser(user) {
			$('#current-user-username').text(user.username)
			$('#current-user').val(user.id)
		}


		function updateUser() {
			var userId = $('#user-id').val();
			var username = $('#register-user').val();
			var email = $('#register-email').val();
			var password = $('#register-pass').val();
			var repeatPassword = $('#confirm-register-pass').val();
			var dietId = $('#select-diet').val();
			if (username === "" || email === "" || password === "" || repeatPassword === "") {
				toggleNotification("Please fill in the requested fields");
				return

			}
			if (!email.includes('@') || !email.includes('.')) {
				toggleNotification("Email is not valid");
				return
			}
			if (password != repeatPassword) {
				toggleNotification("Password must be confirmed");
				return
			}

			$.ajax({
				url: "/user/update/admin",
				method: "POST",
				data: {
					id: userId,
					username: username,
					email: email,
					password: password,
					repeatPassword: repeatPassword,
					diet: dietId
				},
				success: function (response) {
					if (response.includes("Error")) {
						//$('#result-custom-quote').text(response)
						toggleNotification(response)
					}
					else {
						//$('#update-custom-quote').attr("id","submit-custom-quote")
						//$('#submit-custom-quote').html("Add Quote")
						//$('#create-update-quote').text("Create Quote:");
						//$('#input-comment').val('');
						updatePressed = false;
						clearFields();

						//$('#result-custom-quote').text("Quote has been created successfully")
						toggleNotification(response);
						fetchAllUsers();

					}
				},
				fail: function () {

					toggleNotification("Something went terribly wrong!!!")
				}
			})
		}
		function showLoggedUsername(username) {
			$('#logged-user-name').text(username);

		}
		$('#search-btn').on('click',function(){
            
            var searchTerm = $('#search-text').val().trim();
            //var searchType = $('#select-search-type').val().trim();
            if(searchTerm.length>0){
                //if(searchType.length>0){
                Search(searchTerm);
                $('#clear-btn').show();
                //}
                //else{
                    //alert('Incorrect Search Type!');
                //}
            }
            else{
               //alert('Please fill out the search field!');
			   toggleNotification("Please fill out the search field");

            }
        })
		function Search(searchTerm){
           
                 
                    $.ajax({
            		url: "/user/search",
            		method: "POST",
                    //contentType: "application/json",
                    //traditional: true,
            		data : {
            			searchTerm: searchTerm,
            		},
            		complete : function(response){
                        if(response.status==200){
                            console.log(response);
                            clearUserContainer();
                            //clearProductContainer();
                            //HideProductsSegment();
                            console.log(response);
                            if(response.responseJSON.length>0){
                        response.responseJSON.forEach(function(user) {
                        populateUserContainer(user);

                        });
                        }
                        else{
                        var template = $('#empty-template').clone();
                        template.find('h5').text("No Users have been found");
                        $('#user-container').append(template);
                        template.show();
                        }
                       
                    
                            
                        }
                        if(response.status==401){
                            toggleNotification("You are not authorized to perform this operation. Please log in and try again!");

                        }
                        if(response.status==404){
                            clearUserContainer();
                            //HideProductsSegment();
                            //clearRecipeContainer();
                            //ShowRecipesSegment();
                            //alert("Resource couldnt be found!");
                            var template = $('#empty-template').clone();
                            template.find('h5').text("No Users have been found");
                            $('#user-container').append(template);
                            template.show();

                        }
            		},
            		fail : function(){
            			
            			toggleNotification("Something went terribly wrong!!!");
            		}
            	})
                    
                


        }
		function clearUserContainer(){
			$('#user-container').empty();
		}
		$('#clear-btn').hide();
        $('#clear-btn').on('click',function(){
            $('#clear-btn').hide();
            $('#search-text').text("");
			$('#search-text').val("");
            clearUserContainer();
            fetchAllUsers();
        })


	})
	function toggleNotification(message){
		var bar = document.createElement("div");
  		bar.innerHTML = message;
  		bar.classList.add("mbar");
		document.getElementById("mbar").appendChild(bar);
		setTimeout(function(){
			document.getElementById("mbar").removeChild(bar);
  },2000);
	}




</script>

</html>